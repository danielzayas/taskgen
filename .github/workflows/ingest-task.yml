# Harbor Task Ingestion Workflow
#
# This workflow receives task submissions from external repositories
# that use the Harbor Task Checker action.
#
# When an OSS repo's PR passes Harbor validation, the developer can
# click "Submit to Harbor" which triggers this workflow to create a PR
# adding the task to taskgen's tasks/ directory.

name: Ingest External Task

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        type: string
      source_pr:
        description: 'Source PR number'
        required: true
        type: string
      source_run_id:
        description: 'Source workflow run ID (for artifact download)'
        required: true
        type: string
      task_id:
        description: 'Task ID'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  ingest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout taskgen
        uses: actions/checkout@v4
      
      - name: Download task artifact
        uses: actions/download-artifact@v4
        with:
          name: harbor-task-${{ inputs.task_id }}
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.source_run_id }}
          github-token: ${{ secrets.ARTIFACT_DOWNLOAD_TOKEN }}
          path: ./incoming/${{ inputs.task_id }}
      
      - name: Validate task structure
        run: |
          TASK_DIR="./incoming/${{ inputs.task_id }}"
          
          echo "Validating task structure..."
          
          # Check required files exist
          REQUIRED_FILES=(
            "instruction.md"
            "task.toml"
            "environment/Dockerfile"
            "environment/bug.patch"
            "solution/solve.sh"
            "solution/fix.patch"
            "tests/test.sh"
          )
          
          MISSING=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$TASK_DIR/$file" ]]; then
              MISSING+=("$file")
            fi
          done
          
          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo "::error::Missing required files: ${MISSING[*]}"
            exit 1
          fi
          
          echo "âœ… Task structure validated"
          
          # Show task info
          echo ""
          echo "Task ID: ${{ inputs.task_id }}"
          echo "Source: ${{ inputs.source_repo }}#${{ inputs.source_pr }}"
          echo ""
          echo "Files:"
          find "$TASK_DIR" -type f | sort
      
      - name: Check for duplicates
        run: |
          if [[ -d "tasks/${{ inputs.task_id }}" ]]; then
            echo "::error::Task already exists: tasks/${{ inputs.task_id }}"
            exit 1
          fi
          echo "âœ… No duplicate found"
      
      - name: Create PR branch
        id: branch
        run: |
          BRANCH="task/${{ inputs.task_id }}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          
          git config user.name "Harbor Task Bot"
          git config user.email "taskgen-bot@abundant.ai"
          git checkout -b "$BRANCH"
      
      - name: Move task to tasks directory
        run: |
          mkdir -p tasks/
          mv "./incoming/${{ inputs.task_id }}" tasks/
          
          git add tasks/
          git commit -m "Add task: ${{ inputs.task_id }}

          Source: ${{ inputs.source_repo }}#${{ inputs.source_pr }}
          Workflow: https://github.com/${{ inputs.source_repo }}/actions/runs/${{ inputs.source_run_id }}

          Submitted via Harbor Task Checker"
      
      - name: Push branch
        run: |
          git push origin "${{ steps.branch.outputs.branch }}"
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read instruction for PR body (truncate if too long)
          INSTRUCTION=$(head -c 2000 "tasks/${{ inputs.task_id }}/instruction.md" 2>/dev/null || echo "No instruction available")
          
          gh pr create \
            --title "ðŸš€ Add task: ${{ inputs.task_id }}" \
            --body "## Task Submission

          A new Harbor task has been submitted from an external repository.

          | Field | Value |
          |-------|-------|
          | **Task ID** | \`${{ inputs.task_id }}\` |
          | **Source Repo** | [${{ inputs.source_repo }}](https://github.com/${{ inputs.source_repo }}) |
          | **Source PR** | [#${{ inputs.source_pr }}](https://github.com/${{ inputs.source_repo }}/pull/${{ inputs.source_pr }}) |
          | **Validation Run** | [View workflow](https://github.com/${{ inputs.source_repo }}/actions/runs/${{ inputs.source_run_id }}) |

          ---

          ## Task Instruction

          <details>
          <summary>Click to expand instruction.md</summary>

          \`\`\`markdown
          $INSTRUCTION
          \`\`\`

          </details>

          ---

          ## Review Checklist

          - [ ] Instruction clearly describes the bug/feature
          - [ ] Dockerfile looks reasonable for the language/framework
          - [ ] No sensitive data (API keys, credentials, PII)
          - [ ] Task ID follows naming convention (\`owner__repo-pr\`)

          ---

          *Submitted via [Harbor Task Checker](https://github.com/abundant-ai/taskgen)*
          " \
            --base main \
            --head "${{ steps.branch.outputs.branch }}" \
            --label "task-submission"
      
      - name: Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          # âœ… Task Ingestion Complete
          
          A pull request has been created to add this task.
          
          | Field | Value |
          |-------|-------|
          | **Task ID** | \`${{ inputs.task_id }}\` |
          | **Source** | [${{ inputs.source_repo }}#${{ inputs.source_pr }}](https://github.com/${{ inputs.source_repo }}/pull/${{ inputs.source_pr }}) |
          | **Branch** | \`${{ steps.branch.outputs.branch }}\` |
          
          Please review and merge the PR to add this task to the collection.
          EOF

