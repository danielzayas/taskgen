# Harbor Task Checker - Self Test
#
# This workflow tests the Harbor Task Checker action on taskgen's own PRs.
# It serves as both a test and a demonstration of the action.

name: Harbor Task Check (Self-Test)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Also allow manual triggering for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check (leave empty for current branch)'
        required: false
        type: string

jobs:
  self-test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: write
      pull-requests: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Use local action (from this repo)
      - name: Check Harbor Task Eligibility
        id: harbor-check
        uses: ./
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          # For self-test, we enable API keys if available
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          
          # Less strict requirements for self-test
          min_source_files: 2
          
          # Skip validation if no API keys (still tests basic flow)
          # skip_validation: true
      
      - name: Upload Task Artifact
        if: steps.harbor-check.outputs.eligible == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.harbor-check.outputs.artifact_name }}
          path: /tmp/harbor-tasks/${{ steps.harbor-check.outputs.task_id }}
          retention-days: 7
      
      - name: Report Results
        if: always()
        run: |
          echo "## Results"
          echo "Eligible: ${{ steps.harbor-check.outputs.eligible }}"
          echo "Reason: ${{ steps.harbor-check.outputs.reason }}"
          if [[ "${{ steps.harbor-check.outputs.task_id }}" != "" ]]; then
            echo "Task ID: ${{ steps.harbor-check.outputs.task_id }}"
          fi

